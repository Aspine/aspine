<!DOCTYPE html>
<html lang="en">
	<head>

        <title>Aspine | CRLS Student Dashboard</title>

		<meta charset="utf-8">
		<!--===============================================================================================-->
		<meta name="Aspine" content="Aspen Scraper and Beautifier">
		<!--===============================================================================================-->
        <meta name="viewport" content="width=device-width, initial-scale=.75">
		<!--===============================================================================================-->
		<link href="tabulator.css" rel="stylesheet">
		<!--===============================================================================================-->
		<link rel="stylesheet" type="text/css" href="stylesheet.css">
		<!--===============================================================================================-->
		<script type="text/javascript" src="/tabulator/js/tabulator.min.js"></script>
		<!--===============================================================================================-->
		<script type="text/javascript" src="extraFunctions.js"></script>
		<!--===============================================================================================-->
		<script type="text/javascript" src="buttonFunctions.js"></script>
		<!--===============================================================================================-->
		<link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
		<!--===============================================================================================-->
		<link rel="stylesheet" type="text/css" href="css/util.css">
		<!--===============================================================================================-->
		<link rel="stylesheet" type="text/css" href="css/main.css">
		<!--===============================================================================================-->
        <link rel="icon" type="image/png" href="images/icons/favicon.ico"/>

	</head>
	<body>
		<div id="header">
            <div class="logo">
                <img src="images/logo-circle.png" alt="IMG">
            </div>

			<h4 id="title">
				Aspine
			</h4>
		</div>
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'grades')" id="default_open">Grades</button>
            <button class="tablinks" onclick="openTab(event, 'schedule')">Schedule</button>
            <button class="tablinks" onclick="location.href='/logout'" id="logout">Logout</button>
	    <button class="tablinks" id="GPA">Quarter GPA: </button>
        </div>
        <div id="grades" class="tabcontent">
            <div id="classesTable"></div>
	    <div id="categoriesTable"></div>
 	    <div align="center" id="assignmentsButtonDiv">
		    <!--<button class="assignmentsButton login100-form-btn" onclick="newAssignment()">Add Assignment</button>-->
		    <button class="login100-form-btn assignmentsButton" onclick="resetTableData()">Reset Changes</button></div> 
           <div id="assignmentsTable"></div>
        </div>
        <div id="schedule" class="tabcontent">
            <!-- Rounded switch -->
            <label class="switch">
                <input type="checkbox" id="schedule_toggle" onclick="schedule_toggle();">
                <span class="slider round"></span>
                <p id="schedule_title">Black</p>
            </label>
            <div id="scheduleTable"></div>
        </div>
		<script type="text/javascript">
			let tableData = {};
			let selected_class_i;
			let tableDataReset = {};
			//create Tabulator on DOM element with id "assignmentsTable"
			let categoriesTable = new Tabulator("#categoriesTable", {

			//	height: 400,

				layout:"fitColumns",
				columns: [
					{title:"Category", field:"category", formatter: rowFormatter, headerSort: false},
					{title:"Weight", field:"weight", formatter:rowFormatter, headerSort: false},
					{title:"Score", field:"score", formatter: rowFormatter, headerSort: false},
					{title:"Max Score", field:"maxScore", formatter: rowFormatter, headerSort: false},
					{title:"Percentage", field:"grade", formatter: rowFormatter, headerSort:false},
					],
			
			});
			let assignmentsTable = new Tabulator("#assignmentsTable", {
				height:600, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
				//data:tabledata[0].assignments, //assign data to table
				layout:"fitColumns", //fit columns to width of table (optional)
				//rowFormatter:function(row) {
				//	row.getElement().style.backgroundColor = row.getData().color;
				//},
				dataEdited: editAssignment,
				columns:[ //Define Table Columns
					{title:"Assignment", field:"name", editor:"input", formatter: rowFormatter, headerSort:false},
					{title:"Category", field:"category", editor:"select",
						editorParams:function(cell) {
							let catCategories = [];

							for (let k = 0; k < Object.keys(tableData.classes[selected_class_i].categories).length; k++) {
								catCategories.push((Object.keys(tableData.classes[selected_class_i].categories)[k] + " (" + (Object.values(tableData.classes[selected_class_i].categories)[k] * 100)+ "%)"));
							}
							return {values: catCategories};
						}, 
						normatter: rowFormatter, headerSort:false,
					},
					{title:"Score", field:"score", editor:"number", editorParams:{min:0, max:100, step:1,}, formatter: rowFormatter, headerSort:false,},
					{title:"Max Score", field:"max_score", editor:"number", editorParams:{min:0, max:100, step:1,}, formatter: rowFormatter, headerSort:false,},
					{title:"Percentage", field: "percentage", formatter: rowGradeFormatter, headerSort:false,},
					{title: "Add", titleFormatter:addAssignmentFormatter, headerClick: newAssignment, formatter:"buttonCross", width:40, align:"center", cellClick:function(e, cell){
					    cell.getRow().delete();
					}, headerSort:false,},
				],
			});
			//create Tabulator on DOM element with id "scheduleTable"
			let scheduleTable = new Tabulator("#scheduleTable", {
				layout:"fitDataFill", //fit columns to width of table (optional)
				rowFormatter:function(row) {
					row.getElement().style.transition = "all 1s ease";
					row.getElement().style.backgroundColor = row.getData().color;
				},
				columns:[ //Define Table Columns
					{title:"Period", field:"period", width: 150, headerSort:false, formatter: "html"},
					{title:"Room", field:"room", width: 150, headerSort:false},
					{title:"Class", field:"class", headerSort:false, formatter: "html"},
				],
			});
			let classesTable = new Tabulator("#classesTable", {
				//height:205, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
                selectable:1,
				ajaxURL:"/data",
				ajaxConfig:"post", //ajax HTTP request type
				ajaxContentType:"json", // send parameters to the server as a JSON encoded string
				ajaxResponse:function(url, params, response){
					//url - the URL of the request
					//params - the parameters passed with the request
					//response - the JSON object returned in the body of the response.
                    if(response.classes.length == 0) {
                        location.href='/logout';
                    }
					tableData = response;

					document.getElementById("scheduleTable").style.rowBackgroundColor = "black";


					for(let i = 0; i < tableData.classes.length; i++) {

						tableData.classes[i].edited = false;

						tableData.classes[i].categoryGrades = {};

						if (tableData.classes[i].grade != "") {
							tableData.classes[i].decimals = parseFloat(tableData.classes[i].grade).countDecimals();
						}

						
						for (let j = 0; j < tableData.classes[i].assignments.length; j++) {
							tableData.classes[i].assignments[j].percentage = Math.round(tableData.classes[i].assignments[j].score / tableData.classes[i].assignments[j].max_score * 1000) / 10;
							tableData.classes[i].assignments[j].color = getColor(tableData.classes[i].assignments[j].percentage);

							if (isNaN(tableData.classes[i].assignments[j].score)) {
								tableData.classes[i].assignments[j].score = "None";
								tableData.classes[i].assignments[j].max_score = "None";
							}

						}

						if (tableData.classes[i].grade != "") {

							tableData.classes[i].calculated_grade = tableData.classes[i].grade;
							let computingClassData = tableData.classes[i];

							let gradeInfo = determineGradeType(computingClassData.assignments, computingClassData.categories, computingClassData.grade);

							let categoriesArray = Object.keys(gradeInfo.categoryScores);
			let weightsArray = Object.values(computingClassData.categories).map(weight => weight * 100 + "%");
							let scoresArray = Object.values(gradeInfo.categoryScores).map(score => !isNaN(parseFloat(score)) && parseFloat(score) != 0 ? score : "None");
							let maxScoresArray = Object.values(gradeInfo.categoryMaxScores).map(maxScore => !isNaN(parseFloat(maxScore)) && parseFloat(maxScore) != 0 ? maxScore : "None");
			let gradesArray = Object.values(gradeInfo.categoryGrades).map(grade => !isNaN(parseFloat(grade)) ? Math.round(grade * 1000) / 10 + "%" : "No Grade");

							tableData.classes[i].type = gradeInfo.type;

							tableData.classes[i].categoryDisplay = [];

							for (let b = 0; b < categoriesArray.length; b++) {
								let categoryRow = {};
								categoryRow.category = categoriesArray[b];
								categoryRow.weight = weightsArray[b];
								categoryRow.score = scoresArray[b];
								categoryRow.maxScore = maxScoresArray[b];
								categoryRow.grade = gradesArray[b];
								categoryRow.color = getColor(gradesArray[b]);
								tableData.classes[i].categoryDisplay.push(categoryRow);
							}
							tableData.classes[i].calculated_grade = tableData.classes[i].grade; 

							tableData.classes[i].color = getColor(tableData.classes[i].calculated_grade);
						}
					}

					let periods = ["Period 1",  "CM/OTI", "Period 2", "Period 3", "Period 4"];

					let times = ["8:05 - 9:25", "9:29 - 9:44", "9:48 - 11:08", "11:12 - 1:06", "1:10 - 2:30"];

					let colors = ["#00551D", "#006622", "#00802b", "#009933", "#00b33c", "#00cc44"];


					for (let i = 0; i < tableData.schedule.black.length;  i++) {
						tableData.schedule.black[i].period = periods[i] ? periods[i] + "<br>" + times[i] : "Extra"; 
						tableData.schedule.black[i].class = tableData.schedule.black[i].name + "<br>" + tableData.schedule.black[i].teacher;
						tableData.schedule.black[i].color = colors[i] ? colors[i] : colors[colors.length - 1];

						tableData.schedule.silver[i].period = periods[i] ? periods[i] + "<br>" + times[i] : "Extra";
						tableData.schedule.silver[i].class = tableData.schedule.silver[i].name + "<br>" + tableData.schedule.silver[i].teacher;
						tableData.schedule.silver[i].color = colors[colors.length - 1 - i] ? colors[colors.length - 1 - i] : colors[0];
					}
			

					tableData.GPA = computeGPA();
					tableData.calcGPA = computeGPA();
					tableDataReset = JSON.parse(JSON.stringify(tableData));


					document.getElementById("GPA").innerHTML = "Quarter GPA: " + tableData.GPA;

					scheduleTable.setData(response.schedule.black);

					return response.classes; //return the tableData property of a response json object

				},
				//ajaxParams:{key1:"value1", key2:"value2"},
				//data:tabledata, //assign data to table
				layout:"fitColumns", //fit columns to width of table (optional)
				columns:[ //Define Table Columns
					{title:"Class", field:"name", formatter: classesRowFormatter, headerSort:false},
					{title:"Grade", field:"grade", align:"left", formatter:gradeFormatter, headerSort:false},
				],
				rowClick:function(e, row){ //trigger an alert message when the row is clicked
					document.getElementById("categoriesTable").style.display = "block";
					document.getElementById("assignmentsTable").style.display = "block";
					document.getElementById("assignmentsButtonDiv").style.display = "inline-block";
					selected_class_i = row.getPosition();
					tabledata = classesTable.getData();
					for(let i in tabledata) {
						if(tabledata[i].name == row.getData().name) {
							assignmentsTable.setData(tabledata[i].assignments);
							categoriesTable.setData(tabledata[i].categoryDisplay);
							return;
						}
					}
				},
			});
			function schedule_toggle() {
				if(document.getElementById("schedule_toggle").checked) {
					scheduleTable.setData(tableData.schedule.silver);
                    document.getElementById("schedule_title").innerHTML = "Silver";
				} else {
					scheduleTable.setData(tableData.schedule.black);
                    document.getElementById("schedule_title").innerHTML = "Black";
                }
            }
function openTab(evt, tab_name) {
    // Declare all variables
    var i, tabcontent, tablinks;

    // Get all elements with class="tabcontent" and hide them
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }

    // Get all elements with class="tablinks" and remove the class "active"
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the current tab, and add an "active" class to the button that opened the tab
    document.getElementById(tab_name).style.display = "block";
    evt.currentTarget.className += " active";
    classesTable.redraw();
    assignmentsTable.redraw();
    scheduleTable.redraw();
}
document.getElementById("default_open").click();
        </script>
		<script type="text/javascript" src="calculate_grade.js"></script>
	</body>
</html>
