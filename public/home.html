<!DOCTYPE html>
<html lang="en">
	<head>

		<title>Aspine | CRLS Student Dashboard</title>

		<meta name="Description" content="This CRLS Student Dashboard is perfect for keeping up with your Aspen grades, the CRLS Clock, and the CRLS calendar. Checking grades the cool way since 2019!">
		<!--===============================================================================================-->
		<meta charset="utf-8">
		<!--===============================================================================================-->
		<meta name="Aspine" content="Aspen Scraper and Beautifier">
		<!--===============================================================================================-->
        <meta name="viewport" content="width=device-width, initial-scale=.75">
		<!--===============================================================================================-->
		<meta name="theme-color" content="#00551C"/>
		<!--===============================================================================================-->
		<link href="tabulator.css" rel="stylesheet">
		<!--===============================================================================================-->
		<link rel="stylesheet" type="text/css" href="./css/stylesheet.css">
		<!--===============================================================================================-->
		<script type="text/javascript" src="/tabulator/js/tabulator.min.js"></script>
		<!--===============================================================================================-->
		<script type="text/javascript" src="./js/extraFunctions.js"></script>
		<!--===============================================================================================-->
		<script type="text/javascript" src="./js/buttonFunctions.js"></script>
		<!--===============================================================================================-->
		<link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
		<!--===============================================================================================-->
    <!--<link rel="stylesheet" type="text/css" href="css/util.css">-->
		<!--===============================================================================================-->
		<link rel="stylesheet" type="text/css" href="css/main.css">
		<!--===============================================================================================-->
		<link rel="stylesheet" type="text/css" href="css/fullcalendar.min.css">
		<!--===============================================================================================-->
        <link rel="icon" type="image/png" href="images/icons/favicon.ico"/>
        <!--===============================================================================================-->
        <link rel="manifest" href="/manifest.json">
        <!--===============================================================================================-->
        <script src="js/plotly-latest.min.js"></script>
        <!--===============================================================================================-->
        <script src="js/jquery-3.3.1.min.js"></script>
        <!--===============================================================================================-->
          <!--<script src="pdfjs-dist/src/pdf.js"></script>-->
          <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>

        <!--===============================================================================================-->


	</head>
	<body>
		<div id="header" onclick="openTab(event, 'clock')">
            <div class="logo">
                <canvas id="small_clock" width="400" height="400"></canvas>
                <img id="logo" src="images/logo-circle.png" alt="logo" hidden>
            </div>
            <p id="small_clock_period"></p>
			<h4 id="title">
				Aspine
            </h4>
		</div>
		
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'grades')" id="default_open">Grades</button>
            <button class="tablinks" onclick="openTab(event, 'recent')">Recent Activity</button>
            <button class="tablinks" onclick="openTab(event, 'schedule')">Schedule</button>
            <button class="tablinks" onclick="openTab(event, 'clock')">Clock</button>
            <button class="tablinks" onclick="openTab(event, 'calendar-tab')">Calendar</button>
            <button class="tablinks" onclick="openTab(event, 'reports')">Reports</button>
            <button class="tablinks" onclick="location.href='/logout'" id="logout">Logout</button>
            <div class="GPA custom-select" style="width:230px;">
              <select id="gpa_select">
                <option id="init_gpa" value="0">Current Quarter GPA: </option>
                <option id="current_gpa" value="1">Current Quarter GPA: </option>
                <option id="q1_gpa" value="1">Q1 GPA:</option>
                <option id="q2_gpa" value="2">Q2 GPA:</option>
                <option id="q3_gpa" value="3">Q3 GPA:</option>
                <option id="q4_gpa" value="4">Q4 GPA:</option>
              </select>
            </div>
            <!--<button class="tablinks" id="GPA" onclick="resetTableData()">Quarter GPA: </button> -->
        </div>
		<div id="stats_modal" class="modal">

		  <!-- Modal content -->
		  <div id="stats_modal_content" class="modal-content">
			  <span class="close" style="display:inline-block;color:black" onclick="hideModal()">&times;</span>
		    <h3 id="stats_modal_title" style="display:inline-block;position:relative;left:12px;">Modal Title..</h3>
		    <div id="stats_plot" style="display:none;position:relative;top:20px;height:100px;width:250px"> </div>
		    <p id="stats_modal_caption" style="display:inline-block;position:relative;top:7px;color:#0d0d0d;">Modal Caption..</p>
		  </div>

		</div>
        <div id="grades" class="tabcontent">
            <div id="classesTable"></div>
            <div id="categoriesTable"></div>
            <div id="assignmentsTable"></div>
        </div>
        <div id="schedule" class="tabcontent">
            <!-- Rounded switch -->
            <label class="switch">
                <input type="checkbox" id="schedule_toggle" onclick="schedule_toggle();">
                <span class="slider round"></span>
                <p id="schedule_title" class="unselectable">Black</p>
            </label>
            <div id="scheduleTable"></div>
        </div>
        <div id="clock" class="tabcontent">
            <p>Lunch:</p>
            <input type="range" min="0" max="2" value="0" id="lunch_range" onchange="update_lunch()" class="unselectable">
            <p id="lunch_label" class="unselectable">ABC</p>
            <canvas id="large_clock" width="400" height="400"></canvas>
            <img id="logo" src="images/logo-circle.png" alt="logo" hidden>
            <p id="large_clock_period"></p>
        </div>
        <div id="calendar-tab" class="tabcontent">
            <div id="calendar-edit">
                <div id="calendar-list-container" hidden>
                    <ul id='calendar-list' class="ks-cboxtags">
                    </ul>
                </div>
                <div id="calendar-add-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <span class="close" id="calendar-add-close">&times;</span>
                            <h3>Add Calendar</h3>
                        </div>
                        <div class="modal-body">
                            <form id='add-calendar'>
                                <p>*Calendar must be a public Google Calendar</p>
                                <input type="text" name="name" placeholder="Calendar Name">
                                <br>
                                <input type="text" name="id" placeholder="Calendar ID (found in calendar settings)">
                                <br>
                                <input type="text" class="jscolor" name="color" value="268A48">
                                <br>
                                <input id="calendar-add-submit" type="submit" value="Add">
                                <p id='add-calendar-error'></p>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div id='calendar'></div>
        </div>
	<div id="recent" class="tabcontent">
		<label class="switch">
			<input type="checkbox" id="recent_toggle" onclick="recent_toggle();">
			<span class="slider round"></span>
			<p id="recent_title" class="unselectable">Assignments</p>
        </label>
        	<div id="recentActivity"></div>
        	<div id="recentAttendance"></div>
		
        </div>
	<div id="reports" class="tabcontent">


      <div class="pdf_topnav">

        <div class="pdf_custom-select" style="display:inline-block;width:400px;">
          <select id="pdf_select">
          </select>
        </div>

        <span id="expand-pdf-icon" class="right hover" onclick="toggle_fullscreen_pdf()" style="cursor:pointer">
          <i class="fa fa-expand" aria-hidden="true"></i>
        </span>

        <span class="right" style="font-size:26px;position:relative;padding: 0px 15px;top:3px;">
          |
        </span>

        <span class="right hover" onclick="zoom_in_pdf()" style="cursor:pointer">
          <i class="fa fa-plus" aria-hidden="true"></i>
        </span>
        <span class="right hover" onclick="generate_pdf(pdf_index)" style="cursor:pointer">
          ZOOM
        </span>
        <span class="right hover" onclick="zoom_out_pdf()" style="cursor:pointer">
          <i class="fa fa-minus" aria-hidden="true"></i>
        </span>
      </div>

      <div id="pdf-container" style="background:#333;border: solid 3px;width:100%;height:60%;overflow-y:auto;overflow-x:auto;margin:auto;">
      <canvas id="pdf-canvas" width="400" height="400" style="margin:auto;border:1px solid black"></canvas>
    </div>
  </div>

    <script type="text/javascript" src="/js/clock.js"></script>
    <script type="text/javascript" src="/js/jscolor.js"></script>
		<script type="text/javascript" src="/js/calculate_grade.js"></script>
		<!--<script src="/js/request.js"></script>-->
		<script src="/js/bundle.js"></script>
		<script type="text/javascript">



      ////////////////////Global Variables///////
      let pdf_index = 0;
      let termConverter = ['current', 'q1', 'q2', 'q3', 'q4'];
      let pdfrendering = false;
			let statsModal = document.getElementById('stats_modal');
      let currentTerm = "current";

			// When the user clicks anywhere outside of the modal, close it
			window.addEventListener("click", function(event) {
			  if (event.target == statsModal) {
			    hideModal();
			  }
        pdf_closeAllSelect();
        closeAllSelect();
			});

			$('#stats_plot').width($(window).width() * 7 / 11);
			window.addEventListener('resize', function() { 
        if ($('#stats_plot').is(":visible")) { 

          Plotly.Plots.resize(document.getElementById('stats_plot')); 
          let update_size = {
            //width: 800,  // or any new width
            width: $('#stats_modal_content').width(),
            height: 120  // " "
          };

          Plotly.relayout('stats_plot', update_size);
        }

        if ($('#pdf-canvas').is(":visible") && !pdfrendering) { 
          generate_pdf(pdf_index);
        }
      });
			let hideModal = function() {
				document.getElementById('stats_modal').style.display = "none";
				noStats();
				
			}
			let noStats = function() {
				document.getElementById('stats_plot').style.display = "none";
				document.getElementById("stats_plot").style.display = "none";
				document.getElementById("stats_modal_caption").innerHTML = "No statistics information for this assignment.";
				document.getElementById("stats_modal_caption").style.top = "7px";
				document.getElementById("stats_modal_title").innerHTML = "";
				document.getElementById("stats_modal_content").style.height = "80px";
				//document.getElementById("stats_modal_content").style.margin = "300px auto";
				document.getElementById("stats_modal_content").style.top = "140px";
			}

			//let request = require('request');
			let tableData = {};
			let selected_class_i;
			//let classesReset = {};
let termsReset = {};

			let recentAttendance = new Tabulator("#recentAttendance", {

			//	height: 400,

				layout:"fitColumns",

				columns: [
					{title:"Date", field:"date", headerSort: false},
					{title:"Class", field:"classname", headerSort: false},
					{title:"Period", field:"period", headerSort: false},
					{title:"Event", field:"event", headerSort: false,},
					],

			});
			let recentActivity = new Tabulator("#recentActivity", {

			//	height: 400,

				layout:"fitColumns",

				columns: [
					{title:"Date", field:"date", formatter: rowFormatter, headerSort: false},
					{title:"Class", field:"classname", formatter: rowFormatter, headerSort: false},
					{title:"Assignment", field:"assignment", formatter: rowFormatter, headerSort: false},
					{title:"Score", field:"score", formatter: rowFormatter, headerSort: false},
					{title:"Max Score", field:"max_score", formatter: rowFormatter, headerSort: false},
					{title:"Percentage", field:"percentage", formatter: rowGradeFormatter, headerSort: false},
					],
        rowClick:function(e, row){ //trigger an alert message when the row is clicked
          classesTable.selectRow(1);


            var elem = document.getElementById("default_open");
            var evt = new MouseEvent('click', {
                bubbles: true,
                cancelable: true,
                view: window
            });
            // If cancelled, don't dispatch our event
            var canceled = !elem.dispatchEvent(evt);

          assignmentsTable.clearFilter();
					document.getElementById("categoriesTable").style.display = "block";
					document.getElementById("assignmentsTable").style.display = "block";
					selected_class = row.getData().classname;
					tabledata = classesTable.getData();
          classesTable.deselectRow();
          classesTable.selectRow(selected_class);
          //classesTable.getRows()
          //    .filter(row => row.getData().name == selected_class)
          //    .forEach(row => row.toggleSelect());



					for(let i in tabledata) {
						if(tabledata[i].name == row.getData().classname) {
							assignmentsTable.setData(tabledata[i].assignments);
							categoriesTable.setData(tabledata[i].categoryDisplay);
							return;
						}
					}

          classesTable.selectRow(1);

				},


			});
			let categoriesTable = new Tabulator("#categoriesTable", {

			//	height: 400,

                selectable:1,
				layout:"fitColumns",
				columns: [
					{title:"Category", field:"category", formatter: rowFormatter, headerSort: false},
					{title:"Weight", field:"weight", formatter:weightFormatter, headerSort: false},
					{title:"Score", field:"score", formatter: rowFormatter, headerSort: false},
					{title:"Max Score", field:"maxScore", formatter: rowFormatter, headerSort: false},
					{title:"Percentage", field:"grade", formatter: rowGradeFormatter, headerSort:false},
					//filler column to match the assignments table
					//{title: "", width:1, align:"center", headerSort: false}, 
					{title: "Hide", titleFormatter:hideCategoriesFormatter, headerClick: hideCategoriesTable, width:76, headerSort: false},
					],
        rowClick:function(e, row){ //trigger an alert message when the row is clicked
          assignmentsTable.clearFilter();
          assignmentsTable.addFilter([
            {field: "category", type:"=", value: row.getData().category}
            ]);
				},


			});

			//create Tabulator on DOM element with id "assignmentsTable"
			let assignmentsTable = new Tabulator("#assignmentsTable", {
				height:600, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
				//data:tabledata[0].assignments, //assign data to table
				layout:"fitColumns", //fit columns to width of table (optional)
				//rowFormatter:function(row) {
				//	row.getElement().style.backgroundColor = row.getData().color;
				//},
				dataEdited: editAssignment,
				columns:[ //Define Table Columns
					{title:"Assignment", field:"name", editor:"input", formatter: rowFormatter, headerSort:false},
					{title:"Category", field:"category", editor:"select",
						editorParams:function(cell) {
							let catCategories = [];

							for (let k = 0; k < Object.keys(tableData.currentTerm.classes[selected_class_i].categories).length; k++) {
								catCategories.push((Object.keys(tableData.currentTerm.classes[selected_class_i].categories)[k] + " (" + (Object.values(tableData.currentTerm.classes[selected_class_i].categories)[k] * 100)+ "%)"));
							}
							return {values: catCategories};
						},
						formatter: rowFormatter, headerSort:false,
					},
					{title:"Score", field:"score", editor:"number", editorParams:{min:0, max:100, step:1,}, formatter: rowFormatter, headerSort:false,},
					{title:"Max Score", field:"max_score", editor:"number", editorParams:{min:0, max:100, step:1,}, formatter: rowFormatter, headerSort:false,},
					{title:"Percentage", field: "percentage", formatter: rowGradeFormatter, headerSort:false,},
					{title: "Stats", titleFormatter: statInfoHeaderFormatter, formatter: statInfoFormatter, width:40, align:"center", cellClick: async function(e, cell){
					if (!isNaN(cell.getRow().getData().score)) {
						noStats();
						document.getElementById("stats_modal_caption").innerHTML = "Loading Statistics...";
						document.getElementById("stats_modal_title").innerHTML = "";
						document.getElementById('stats_modal').style.display = "inline-block";

						let session_id = tableData.currentTerm.classes[selected_class_i].tokens.session_id;
						let apache_token = tableData.currentTerm.classes[selected_class_i].tokens.apache_token;
						let assignment_id = cell.getRow().getData().assignment_id;
						let assignment = cell.getRow().getData().name;
						let score = cell.getRow().getData().score;
						let max_score = cell.getRow().getData().max_score;

						
						let stats = await window.getStats(session_id, apache_token, assignment_id);
						//let stats = '["8","6","8","7.5"]';
						//let stats = 'No Statistics Data for this assignment';

						if (stats.indexOf("[") === 0) {
							stats = stats.substring(1, stats.length - 1);

							stats = stats.split(",");
							stats = stats.map(x => parseFloat(x.substring(1, x.length)));
              //console.log("Raw Stats: " + stats);
							let high = stats[0], low = stats[1], median = stats[2], mean = stats[3];
              let q1 = (low + median) / 2, q3 = (high + median) / 2;

              let graph_stats = [low, q1, median, q3, high];
              //console.log("Graph Stats: " + graph_stats);
              //console.log("Mean: " + mean)

							var statsTrace = {
							  x: graph_stats,
							  type: 'box',
								name: " ",
                marker:{
                    //color: '#268A48'
                    color: '#ff66ff'
                  }
							};

              
							var data = [statsTrace];

							let layout = {
								title: " ",
								width: $('#stats_modal_content').width(),
								height: 120,

								xaxis: {
									title: " ",
									zeroline: true,
									range: [0, 15 * max_score / 14],
                  tickfont: {
                    family: 'Poppins-Bold, Arial, Helvetica, sans-serif',
                    size: 12,
                    color: '#000',
                  },
								},

								yaxis: {
									range: [-1.15, 0.7],
                  tickfont: {
                    family: 'Poppins-Bold, Arial, Helvetica, sans-serif',
                    size: 12,
                    color: '#000',
                  },
								},

								margin: {
									t: 20,
									l: 20,
									r: 20,
									b: 20,
								},
								shapes: [
                  //your score line
									{
										type: 'line',
										x0:score  - (max_score / 1000),
										y0:-0.50,
										x1: score - (max_score / 1000),
										y1: 0.50,
										line: {
											color: getColor(score / max_score * 100),
											width: 3,
										},
									},
                  //mean line
									{
										type: 'line',
										x0:mean - (max_score / 1000),
										y0:-0.5,
										x1: mean - (max_score / 1000),
										y1: 0.5,
										line: {
											color: getLightColor(mean / max_score * 100),
											width: 3,
										},
									},
 
								],

                annotations: [
                  {
                    x: mean - (max_score / 68),
                    y: -.65,
                    xref: 'x',
                    yref: 'y',
                    text: 'Mean',
                    showarrow: false,
                    font: {
                      family: 'Poppins-Bold, Arial, Helvetica, sans-serif',
                      size: 12,
											color: getLightColor(mean / max_score * 100),
                    },
                  },
                  {
                    x: score - (max_score / 38),
                    y: .65,
                    xref: 'x',
                    yref: 'y',
                    text: 'Your Score',
                    showarrow: false,
                    font: {
                      family: 'Poppins-Bold, Arial, Helvetica, sans-serif',
                      size: 12,
											color: getColor(score / max_score * 100),
                    },
                  },
                ],
							};
              for (let i = 5; i <= 10; i++) {
                  let shape = {
                    type: 'line',
                    x0: max_score * i / 10,
                    y0: -0.90,
                    x1: max_score * i / 10,
                    y1: -1.15,
                    line: {
                      color: getColor(i * 10),
                      width: 2,
                    },
                  };
                  layout.shapes.push(shape);
              }
            for (let i = 5; i <= 9; i++) {
                  let annotation = {
                    x: max_score * i / 10 + max_score / 20,
                    y: -1.05,
                    xref: 'x',
                    yref: 'y',
                    text: getLetterGrade(((i + 0.5) / 10) * 100),
                    showarrow: false,
                    font: {
                      family: 'Poppins-Bold, Arial, Helvetica, sans-serif',
                      size: 12,
											color: getColor(((i + 0.5) / 10) * 100),
                    },
                  }
                  layout.annotations.push(annotation);
            }

						


							let TESTER = document.getElementById("stats_plot");

							TESTER.style.display = "inline";

							Plotly.newPlot(TESTER, data, layout, {displayModeBar: false, responsive: true, });

		
							document.getElementById("stats_modal_title").innerHTML = "Grade Statistics for: <br>" + assignment.substring(0, 30);
							document.getElementById("stats_modal_caption").style.top = "30px";
							document.getElementById("stats_modal_caption").innerHTML = "Score" + "<br><br>" + "Your Score: " + score + ", Max Points: " + max_score + "<br>" + "Mean: " + mean + "<br>" + "Low: " + low + ", Median: " + median + ", High: " + high;

							document.getElementById("stats_modal_content").style.height = "365px";
							document.getElementById("stats_modal_content").style.margin = "15% auto";
						} else {
							
							noStats();
							
						}
					}

						

					}, headerSort:false,},
					{title: "Add", titleFormatter:addAssignmentFormatter, headerClick: newAssignment, formatter:"buttonCross", width:40, align:"center", cellClick:function(e, cell){
					    cell.getRow().delete();
					}, headerSort:false,},
				],
			});
			//create Tabulator on DOM element with id "scheduleTable"
			let scheduleTable = new Tabulator("#scheduleTable", {
				layout:"fitDataFill", //fit columns to width of table (optional)
				rowFormatter:function(row) {
					row.getElement().style.transition = "all 1s ease";
					row.getElement().style.backgroundColor = row.getData().color;
				},
				columns:[ //Define Table Columns
					{title:"Period", field:"period", width: 150, headerSort:false, formatter: "html"},
					{title:"Room", field:"room", width: 150, headerSort:false},
					{title:"Class", field:"class", headerSort:false, formatter: "html"},
				],
			});
			let classesTable = new Tabulator("#classesTable", {
				//height:205, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
        index: "name",
                		selectable:1,
				ajaxURL:"/data",
				ajaxConfig:"post", //ajax HTTP request type
				ajaxContentType:"json", // send parameters to the server as a JSON encoded string
				ajaxResponse:function(url, params, response){
					//url - the URL of the request
					//params - the parameters passed with the request
					//response - the JSON object returned in the body of the response.

          if(((response.schedule)).login_fail) {
              location.href='/logout';
          }

          if (response.currentTerm.classes.length == 0) {

            response.currentTerm.classes = 
            [
                {
                  "name": "No Classes",
                  "grade": "No Grades",
                  "categories": {
                    "No Categories": "1.0"
                  },
                  "assignments": [
                    {
                      "name": "No Assignments",
                      "category": "No Categories",
                      "assignment_id": "GCD000000Fx62l",
                      "special": "No Special",
                      "score": 10,
                      "max_score": 10,
                      "percentage": 100,
                      "color": "#6666FF"
                    }
                  ],
                  "tokens": {
                    "session_id": "263A6A78DE0F001DDDFC8A525D31A8F0",
                    "apache_token": "572aa56a8c407a6d9a25b0a50843fc32"
                  },
                  "edited": false,
                  "categoryGrades": {},
                  "decimals": 2,
                  "categoryDisplay": [
                    {
                      "category": "HW, Classwork, Assessments",
                      "weight": "30%",
                      "score": 340,
                      "maxScore": 400,
                      "grade": "85%",
                      "color": "#6666FF"
                    },
                    {
                      "category": "Speak-Listen",
                      "weight": "20%",
                      "score": "Ungraded",
                      "maxScore": "Ungraded",
                      "grade": "No Grade",
                      "color": "black"
                    },
                    {
                      "category": "Tests, Quizzes, vocabulary",
                      "weight": "30%",
                      "score": 100,
                      "maxScore": 100,
                      "grade": "100%",
                      "color": "#1E8541"
                    },
                    {
                      "category": "timeliness, effort",
                      "weight": "20%",
                      "score": 200,
                      "maxScore": 200,
                      "grade": "100%",
                      "color": "#1E8541"
                    }
                  ],
                  "type": "categoryPercent",
                  "calculated_grade": "94.05 A",
                  "color": "#1E8541"
                }
              ];
          }

					tableData = response;


					document.getElementById("scheduleTable").style.rowBackgroundColor = "black";


					//parsing the data extracted by the scrappers, and getting tableData ready for presentation
            tableData.currentTerm = parseTableData(tableData.currentTerm.classes);
            tableData.terms.current = parseTableData(tableData.terms.current.classes);
            tableData.terms.q1 = parseTableData(tableData.terms.q1.classes);
            tableData.terms.q2 = parseTableData(tableData.terms.q2.classes);
            tableData.terms.q3 = parseTableData(tableData.terms.q3.classes);
            tableData.terms.q4 = parseTableData(tableData.terms.q4.classes);
          tableData.currentTerm = tableData.terms.current;




					//the following lines are used to set up the schedule table correctly
					//let periods = ["Period 1",  "CM/OTI", "Period 2", "Period 3", "Period 4"];
					let periods = tableData.schedule.black.slice().map(x => x.aspenPeriod.substring(x.aspenPeriod.indexOf("-") + 1));
					let placeTimes = ["8:05 - 9:25", "9:29 - 9:44", "9:48 - 11:08", "11:12 - 1:06", "1:10 - 2:30"];
					let timesCounter = 0;
					let times = []

					for (let i = 0; i < periods.length; i++) {

						if (!isNaN(parseFloat(periods[i])) || periods[i] === "CM") {
							times[i] = placeTimes[timesCounter];
							timesCounter++;
						} else {
							times[i] = "";
						}

					}

					periods = periods.filter(Boolean).map(x => "Period: " + x);


					let colors = ["#63C082", "#72C68E", "#82CC9B", "#91D2A7", "#A1D9B4", "#B1DFC0", "#C0E5CD", "#D0ECD9"];


					for (let i = 0; i < periods.length;  i++) {
						tableData.schedule.black[i].period = periods[i] ? periods[i] + "<br>" + times[i] : "Extra";
						tableData.schedule.black[i].class = tableData.schedule.black[i].name + "<br>" + tableData.schedule.black[i].teacher;
						tableData.schedule.black[i].color = colors[i] ? colors[i] : colors[colors.length - 1];

						tableData.schedule.silver[i].period = periods[i] ? periods[i] + "<br>" + times[i] : "Extra";
						tableData.schedule.silver[i].class = tableData.schedule.silver[i].name + "<br>" + tableData.schedule.silver[i].teacher;
						tableData.schedule.silver[i].color = colors[colors.length - 1 - i] ? colors[colors.length - 1 - i] : colors[0];
					}



					//populates the event for each row in the recentAttendance table
					for (let i = 0; i < tableData.recent.recentAttendanceArray.length; i++) {
						tableData.recent.recentAttendanceArray[i].event = "";
						if (tableData.recent.recentAttendanceArray[i].dismissed === "true") {
							tableData.recent.recentAttendanceArray[i].event += "Dismissed ";
						}
						if (tableData.recent.recentAttendanceArray[i].excused === "true") {
							tableData.recent.recentAttendanceArray[i].event += "Excused ";
						}
						if (tableData.recent.recentAttendanceArray[i].absent === "true") {
							tableData.recent.recentAttendanceArray[i].event += "Absent ";
						}
						if (tableData.recent.recentAttendanceArray[i].tardy === "true") {
							tableData.recent.recentAttendanceArray[i].event += "Tardy ";
						}
					}


					let activityArray = tableData.recent.recentActivityArray.slice();
					for (let i = 0; i < activityArray.length; i++) {
						try {
						let assignmentName = activityArray[i].assignment;
						let className = activityArray[i].classname;
						let classIndex = tableData.currentTerm.classes.map(x => x.name).indexOf(className);

						let assignmentIndex = tableData.currentTerm.classes[classIndex].assignments.map(x => x.name).indexOf(assignmentName);

						tableData.recent.recentActivityArray[i].assignmentName = assignmentName;
						tableData.recent.recentActivityArray[i].className = className;
						tableData.recent.recentActivityArray[i].classIndex = classIndex;
						tableData.recent.recentActivityArray[i].assignmentIndex = assignmentIndex;

						tableData.recent.recentActivityArray[i].max_score = tableData.currentTerm.classes[classIndex].assignments[assignmentIndex].max_score;
						tableData.recent.recentActivityArray[i].percentage = tableData.currentTerm.classes[classIndex].assignments[assignmentIndex].percentage;
						tableData.recent.recentActivityArray[i].color = tableData.currentTerm.classes[classIndex].assignments[assignmentIndex].color;
						} catch(err) {
							console.log("Please report this error on the Aspine github issue pages. ID Number 101. Error: " + err);

						}




					}

					//final touches. declaring GPA, calcGPA, termsReset, and then setting the data for each of the tables.
					//tableData.GPA = computeGPA();
					//tableData.calcGPA = computeGPA();

          initialize_dropdown();
					termsReset = JSON.parse(JSON.stringify(tableData.terms));

					$(".select-selected").html("Current Quarter GPA: " + tableData.currentTerm.GPA);
          $(".select-items").children().each(function(i, elem) {
            if (i == 0) {
              $(this).html("Current Quarter GPA: " + tableData.terms["current"].GPA);
              document.getElementById('gpa_select').options[0].innerHTML = "Current Quarter GPA: " + tableData.terms["current"].GPA;
              document.getElementById('gpa_select').options[1].innerHTML = "Current Quarter GPA: " + tableData.terms["current"].GPA;
            } else {
              $(this).html("Q" + i + " GPA: " + tableData.terms["q" + i].GPA);
              document.getElementById('gpa_select').options[i + 1].innerHTML ="Q" + i + " GPA: " + tableData.terms["q" + i].GPA; 
            }
          });
					scheduleTable.setData(tableData.schedule.black);
					recentActivity.setData(tableData.recent.recentActivityArray);
					recentAttendance.setData(tableData.recent.recentAttendanceArray);

          redraw_clock();


					return response.currentTerm.classes; //return the tableData property of a response json object

				},
				//ajaxParams:{key1:"value1", key2:"value2"},
				//data:tabledata, //assign data to table
				layout:"fitColumns", //fit columns to width of table (optional)
				columns:[ //Define Table Columns
					{title:"Class", field:"name", formatter: classesRowFormatter, headerSort:false},
					{title:"Grade", field:"grade", align:"left", formatter:gradeFormatter, width: 300, headerSort:false},
					{title: "Hide", field: "refresh", titleFormatter:refreshClassFormatter, headerClick: resetTableData, width:156, headerSort: false},
				],
				rowClick:function(e, row){ //trigger an alert message when the row is clicked
          assignmentsTable.clearFilter();
					document.getElementById("categoriesTable").style.display = "block";
					document.getElementById("assignmentsTable").style.display = "block";
					selected_class_i = row.getPosition();
					tabledata = classesTable.getData();
					for(let i in tabledata) {
						if(tabledata[i].name == row.getData().name) {
							assignmentsTable.setData(tabledata[i].assignments);
							categoriesTable.setData(tabledata[i].categoryDisplay);
							return;
						}
					}
				},
			});
			function recent_toggle() {
				if(!document.getElementById("recent_toggle").checked) {
					//recentActivity.setData(tableData.recent.recentActivityArray);
					document.getElementById("recentActivity").style.display = "block";
					document.getElementById("recentAttendance").style.display = "none";
					document.getElementById("recent_title").innerHTML = "Assignments";
		    			recentActivity.redraw();
				} else {
					//recentActivity.setData(tableData.recent.recentAttendanceArray);
					document.getElementById("recentActivity").style.display = "none";
					document.getElementById("recentAttendance").style.display = "block";
					document.getElementById("recent_title").innerHTML = "Attendance";
		    			recentAttendance.redraw();
				}
		        }
			function schedule_toggle() {
				if(document.getElementById("schedule_toggle").checked) {
					scheduleTable.setData(tableData.schedule.silver);
					document.getElementById("schedule_title").innerHTML = "Silver";
                    redraw_clock();
				} else {
					scheduleTable.setData(tableData.schedule.black);
					document.getElementById("schedule_title").innerHTML = "Black";
                    redraw_clock();
				}
		        }
		function openTab(evt, tab_name) {
		    // Declare all variables
		    var i, tabcontent, tablinks;

		    // Get all elements with class="tabcontent" and hide them
		    tabcontent = document.getElementsByClassName("tabcontent");
		    for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
		    }

		    // Get all elements with class="tablinks" and remove the class "active"
		    tablinks = document.getElementsByClassName("tablinks");
		    for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
		    }

		    // Show the current tab, and add an "active" class to the button that opened the tab
		    document.getElementById(tab_name).style.display = "block";
		    evt.currentTarget.className += " active";

            if(tab_name == "clock") {
                document.getElementById("small_clock").style.display = "none";
                document.getElementById("small_clock_period").style.display = "none";
            } else {
                document.getElementById("small_clock").style.display = "block";
                document.getElementById("small_clock_period").style.display = "block";
            }

            if (tab_name == "reports") {




              generate_pdf(pdf_index);
            }

		    classesTable.redraw();
		    assignmentsTable.redraw();
		    scheduleTable.redraw();
		    categoriesTable.redraw();
		    recentActivity.redraw();
		    recentAttendance.redraw();
		}
		document.getElementById("default_open").click();

		
		</script>

		<script type="text/javascript" src="/js/app.js"></script>
	</body>
</html>
