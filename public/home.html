<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="Aspine" content="Aspen Scraper and Beautifier">
		<link href="tabulator.css" rel="stylesheet">
		<script type="text/javascript" src="/tabulator/js/tabulator.min.js"></script>
		<link rel="stylesheet" type="text/css" href="stylesheet.css">
		<script type="text/javascript" src="extraFunctions.js"></script>
		<script type="text/javascript" src="buttonFunctions.js"></script>
	</head>
	<body>
		<h4 id="title">Aspine</h4>
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'grades')" id="default_open">Grades</button>
            <button class="tablinks" onclick="openTab(event, 'schedule')">Schedule</button>
        </div>
        <div id="grades" class="tabcontent">
            <div id="classesTable"></div>
            <div id="assignmentsTable"></div>
            <div align="center"><button class="addAssignment" onclick="newAssignment()">Add Assignment</button></div> 
        </div>
        <div id="schedule" class="tabcontent">
            <!-- Rounded switch -->
            <label class="switch">
                <input type="checkbox" id="schedule_toggle" onclick="schedule_toggle();">
                <span class="slider round"></span>
                <!--<h1>Black Day</h1> -->
            </label>
            <br><br>
            <div id="scheduleTable"></div>
        </div>
		<script type="text/javascript">
			let tableData = {};
			let selected_class_i = 0;
			//create Tabulator on DOM element with id "assignmentsTable"
			let assignmentsTable = new Tabulator("#assignmentsTable", {
				//height:205, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
				//data:tabledata[0].assignments, //assign data to table
				layout:"fitColumns", //fit columns to width of table (optional)
				//rowFormatter:function(row) {
				//	row.getElement().style.backgroundColor = row.getData().color;
				//},
				dataEdited: editAssignment,
				columns:[ //Define Table Columns
					{title:"Assignment", field:"name", editor:"input", formatter: rowFormatter,},
					{title:"Category", field:"category", editor:"select",
						editorParams:function(cell) {
							return {values:Object.keys(tableData.classes[selected_class_i].categories)};
						}, 
						formatter: rowFormatter,
					},
					{title:"Score", field:"score", editor:"number", editorParams:{min:0, max:100, step:1,}, formatter: rowFormatter,},
					{title:"Max Score", field:"max_score", editor:"number", editorParams:{min:0, max:100, step:1,}, formatter: rowFormatter,},
					{title:"Percentage", field: "percentage", formatter: rowGradeFormatter},
					{formatter:"buttonCross", width:40, align:"center", cellClick:function(e, cell){
					    cell.getRow().delete();
					}},
				],
			});
			//create Tabulator on DOM element with id "scheduleTable"
			let scheduleTable = new Tabulator("#scheduleTable", {
				layout:"fitColumns", //fit columns to width of table (optional)
				columns:[ //Define Table Columns
					{title:"Block", field:"block"},
					{title:"Class", field:"name"},
					{title:"Teacher", field:"teacher"},
					{title:"Room", field:"room"},
				],
			});
			let classesTable = new Tabulator("#classesTable", {
				//height:205, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
				ajaxURL:"/data",
				ajaxConfig:"post", //ajax HTTP request type
				ajaxContentType:"json", // send parameters to the server as a JSON encoded string
				ajaxResponse:function(url, params, response){
					//url - the URL of the request
					//params - the parameters passed with the request
					//response - the JSON object returned in the body of the response.
					tableData = response;

					for(let i = 0; i < tableData.classes.length; i++) {

						for (let j = 0; j < tableData.classes[i].assignments.length; j++) {
							tableData.classes[i].assignments[j].percentage = Math.round(tableData.classes[i].assignments[j].score / tableData.classes[i].assignments[j].max_score * 1000) / 10;
							tableData.classes[i].assignments[j].color = getColor(tableData.classes[i].assignments[j].percentage);

							if (isNaN(tableData.classes[i].assignments[j].score)) {
								tableData.classes[i].assignments[j].score = "None";
								tableData.classes[i].assignments[j].max_score = "None";
							}

						}

						if (tableData.classes[i].grade != "") {

							let computingClassData = tableData.classes[i];
							tableData.classes[i].type = determineGradeType(computingClassData.assignments.map(assignment => assignment.category), computingClassData.assignments.map(assignment => assignment.score === "None" ? 0 : assignment.score), computingClassData.assignments.map(assignment => assignment.max_score === "None" ? 0 : assignment.max_score), Object.keys(computingClassData.categories), Object.values(computingClassData.categories), computingClassData.grade);

							tableData.classes[i].calculated_grade = computeGrade(computingClassData.assignments.map(assignment => assignment.category), computingClassData.assignments.map(assignment => assignment.score === "None" ? 0 : assignment.score), computingClassData.assignments.map(assignment => assignment.max_score === "None" ? 0 : assignment.max_score), Object.keys(computingClassData.categories), Object.values(computingClassData.categories), tableData.classes[i].type);

							tableData.classes[i].color = getColor(tableData.classes[i].calculated_grade);
						}
					}

					let blocks = [
						"Period 1  |  8:05 - 9:25",
						"CM/OTI      |  9:29 - 9:44",
						"Period 2  |  9:48 - 11:08",
						"Period 3  |  11:12 - 1:06",
						"Period 4  |  1:10 - 2:30"
					];

					for (let i = 0; i < 5;  i++) {
						tableData.schedule.black[i].block = blocks[i]; 
						tableData.schedule.silver[i].block = blocks[i];
					}

					scheduleTable.setData(response.schedule.black);

					return response.classes; //return the tableData property of a response json object

				},
				//ajaxParams:{key1:"value1", key2:"value2"},
				//data:tabledata, //assign data to table
				layout:"fitColumns", //fit columns to width of table (optional)
				columns:[ //Define Table Columns
					{title:"Class", field:"name", formatter: classesRowFormatter},
					{title:"Grade", field:"grade", align:"left", formatter:gradeFormatter},
					{title:"Calculated Grade", field:"calculated_grade", align:"left", formatter:gradeFormatter},
				],
				rowClick:function(e, row){ //trigger an alert message when the row is clicked
					selected_class_i = row.getPosition();
					tabledata = classesTable.getData();
					for(let i in tabledata) {
						if(tabledata[i].name == row.getData().name) {
							assignmentsTable.setData(tabledata[i].assignments);
							return;
						}
					}
				},
			});
			function schedule_toggle() {
				if(document.getElementById("schedule_toggle").checked) {
					scheduleTable.setData(tableData.schedule.silver);
				} else {
					scheduleTable.setData(tableData.schedule.black);
                }
            }
function openTab(evt, tab_name) {
    // Declare all variables
    var i, tabcontent, tablinks;

    // Get all elements with class="tabcontent" and hide them
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }

    // Get all elements with class="tablinks" and remove the class "active"
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the current tab, and add an "active" class to the button that opened the tab
    document.getElementById(tab_name).style.display = "block";
    evt.currentTarget.className += " active";
    classesTable.redraw();
    assignmentsTable.redraw();
    scheduleTable.redraw();
}
document.getElementById("default_open").click();
        </script>
		<script type="text/javascript" src="calculate_grade.js"></script>
	</body>
</html>
