<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="Aspine" content="Aspen Scraper and Beautifier">
		<link href="tabulator.css" rel="stylesheet">
		<script type="text/javascript" src="/tabulator/js/tabulator.min.js"></script>
		<link rel="stylesheet" type="text/css" href="stylesheet.css">
		<script type="text/javascript" src="extraFunctions.js"></script>
		<script type="text/javascript" src="buttonFunctions.js"></script>
	</head>
	<body>
		<h4 id="title">Aspine</h4>
		<div id="classesTable"></div>
		<div id="assignmentsTable"></div>
		<div align="center"><button class="addAssignment" onclick="newAssignment()">Add Assignment</button></div> 
		<br><br><br>
		<h4 id="title">Schedule</h4>
		<!-- Rounded switch -->
		<label class="switch">
			<input type="checkbox" id="schedule_toggle" onclick="schedule_toggle();">
			<span class="slider round"></span>
			<!--<h1>Black Day</h1> -->
		</label>
		<br><br>
		<div id="scheduleTable"></div>
		<script type="text/javascript">

			let tableData = {};
			let selected_class_i = 0;
			//create Tabulator on DOM element with id "assignmentsTable"
			let assignmentsTable = new Tabulator("#assignmentsTable", {
				//height:205, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
				//data:tabledata[0].assignments, //assign data to table
				layout:"fitColumns", //fit columns to width of table (optional)
				//rowFormatter:function(row) {
				//	row.getElement().style.backgroundColor = row.getData().color;
				//},
				dataEdited: editAssignment,
				columns:[ //Define Table Columns
					{title:"Assignment", field:"name", editor:"input", formatter: rowFormatter,},
					{title:"Category", field:"category", editor:"select",
						editorParams:function(cell) {
							return {values:Object.keys(tableData.classes[selected_class_i].categories)};
						}, 
						formatter: rowFormatter,
					},
					{title:"Score", field:"score", editor:"number", editorParams:{min:0, max:100, step:1,}, formatter: rowFormatter,},
					{title:"Max Score", field:"max_score", editor:"number", editorParams:{min:0, max:100, step:1,}, formatter: rowFormatter,},
					{title:"Percentage", field: "percentage", formatter: rowGradeFormatter},
				],
			});
			//create Tabulator on DOM element with id "scheduleTable"
			let scheduleTable = new Tabulator("#scheduleTable", {
				layout:"fitColumns", //fit columns to width of table (optional)
				columns:[ //Define Table Columns
					{title:"Class", field:"name"},
					{title:"Teacher", field:"teacher"},
					{title:"Room", field:"room"},
				],
			});
			let classesTable = new Tabulator("#classesTable", {
				//height:205, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
				ajaxURL:"/data",
				ajaxConfig:"post", //ajax HTTP request type
				ajaxContentType:"json", // send parameters to the server as a JSON encoded string
				ajaxResponse:function(url, params, response){
					//url - the URL of the request
					//params - the parameters passed with the request
					//response - the JSON object returned in the body of the response.
					tableData = response;

					for(let i = 0; i < tableData.classes.length; i++) {

						for (let j = 0; j < tableData.classes[i].assignments.length; j++) {
							tableData.classes[i].assignments[j].percentage = Math.round(tableData.classes[i].assignments[j].score / tableData.classes[i].assignments[j].max_score * 1000) / 10;
							tableData.classes[i].assignments[j].color = getColor(tableData.classes[i].assignments[j].percentage);

							if (isNaN(tableData.classes[i].assignments[j].score)) {
								tableData.classes[i].assignments[j].score = "None";
								tableData.classes[i].assignments[j].max_score = "None";
							}

						}

						if (tableData.classes[i].grade != "") {

							let computingClassData = tableData.classes[i];
							tableData.classes[i].type = determineGradeType(computingClassData.assignments.map(assignment => assignment.category), computingClassData.assignments.map(assignment => assignment.score === "None" ? 0 : assignment.score), computingClassData.assignments.map(assignment => assignment.max_score === "None" ? 0 : assignment.max_score), Object.keys(computingClassData.categories), Object.values(computingClassData.categories), computingClassData.grade);

							tableData.classes[i].calculated_grade = computeGrade(computingClassData.assignments.map(assignment => assignment.category), computingClassData.assignments.map(assignment => assignment.score === "None" ? 0 : assignment.score), computingClassData.assignments.map(assignment => assignment.max_score === "None" ? 0 : assignment.max_score), Object.keys(computingClassData.categories), Object.values(computingClassData.categories), tableData.classes[i].type);

							tableData.classes[i].color = getColor(tableData.classes[i].calculated_grade);
						}
					}

					scheduleTable.setData(response.schedule.black);

					return response.classes; //return the tableData property of a response json object

				},
				//ajaxParams:{key1:"value1", key2:"value2"},
				//data:tabledata, //assign data to table
				layout:"fitColumns", //fit columns to width of table (optional)
				columns:[ //Define Table Columns
					{title:"Class", field:"name", formatter: classesRowFormatter},
					{title:"Grade", field:"grade", align:"left", formatter:gradeFormatter},
					{title:"Calculated Grade", field:"calculated_grade", align:"left", formatter:gradeFormatter},
				],
				rowClick:function(e, row){ //trigger an alert message when the row is clicked
					selected_class_i = row.getPosition();
					tabledata = classesTable.getData();
					for(let i in tabledata) {
						if(tabledata[i].name == row.getData().name) {
							assignmentsTable.setData(tabledata[i].assignments);
							return;
						}
					}
				},
			});
			function schedule_toggle() {
				if(document.getElementById("schedule_toggle").checked) {
					scheduleTable.setData(tableData.schedule.silver);
				} else {
					scheduleTable.setData(tableData.schedule.black);
				}
			}
		</script>
		<script type="text/javascript" src="calculate_grade.js"></script>


	</body>
</html>
