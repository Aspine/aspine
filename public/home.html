<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="Aspine" content="Aspen Scraper and Beautifier">
		<link href="tabulator.css" rel="stylesheet">
		<script type="text/javascript" src="/tabulator/js/tabulator.min.js"></script>
		<link rel="stylesheet" type="text/css" href="stylesheet.css">
	</head>
	<body>
		<h4 id="title">Aspine</h4>
		<div id="example-table"></div>
        <div id="example-table2"></div>
        <br>
        <!-- Rounded switch -->
        <label class="switch">
            <input type="checkbox" id="schedule_toggle" onclick="schedule_toggle();">
            <span class="slider round"></span>
        </label>
        <br><br>
        <div id="example-table3"></div>
		<script type="text/javascript">
			let tableData = {};
            let selected_class_i = 0;
//create Tabulator on DOM element with id "example-table"
let table2 = new Tabulator("#example-table2", {
	//height:205, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
	//data:tabledata[0].assignments, //assign data to table
	layout:"fitColumns", //fit columns to width of table (optional)
	columns:[ //Define Table Columns
		{title:"Assignment", field:"name", editor:"input"},
        {title:"Category", field:"category", editor:"select",
            editorParams:function(cell) {
                console.log(tableData.classes[selected_class_i].categories);
                return {values:Object.keys(tableData.classes[selected_class_i].categories)};
            }
        },
		{title:"Score", field:"score", editor:"number", editorParams:{min:0, max:100, step:1,}},
		{title:"Max Score", field:"max_score", editor:"number", editorParams:{min:0, max:100, step:1,}},
		{title:"Percentage", field: "percentage"},
	],
});
//create Tabulator on DOM element with id "example-table"
let table3 = new Tabulator("#example-table3", {
	layout:"fitColumns", //fit columns to width of table (optional)
	columns:[ //Define Table Columns
        {title:"Class", field:"name"},
        {title:"Teacher", field:"teacher"},
        {title:"Room", field:"room"},
	],
});
let table = new Tabulator("#example-table", {
	//height:205, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
	ajaxURL:"/data",
	ajaxConfig:"post", //ajax HTTP request type
	ajaxContentType:"json", // send parameters to the server as a JSON encoded string
	ajaxResponse:function(url, params, response){
		//url - the URL of the request
		//params - the parameters passed with the request
		//response - the JSON object returned in the body of the response.
		tableData = response;
    
		for(let i = 0; i < tableData.classes.length; i++) {
			if (tableData.classes[i].grade != "") {

			let computingClassData = tableData.classes[i];
			let type = determineGradeType(computingClassData.assignments.map(assignment => assignment.category), computingClassData.assignments.map(assignment => assignment.score === undefined ? 0 : assignment.score), computingClassData.assignments.map(assignment => assignment.max_score === undefined ? 0 : assignment.max_score), Object.keys(computingClassData.categories), Object.values(computingClassData.categories), computingClassData.grade);

			tableData.classes[i].calculated_grade = computeGrade(computingClassData.assignments.map(assignment => assignment.category), computingClassData.assignments.map(assignment => assignment.score === undefined ? 0 : assignment.score), computingClassData.assignments.map(assignment => assignment.max_score === undefined ? 0 : assignment.max_score), Object.keys(computingClassData.categories), Object.values(computingClassData.categories), type);
			}
		}
		
		table3.setData(response.schedule.black);

		return response.classes; //return the tableData property of a response json object
	},
	//ajaxParams:{key1:"value1", key2:"value2"},
	//data:tabledata, //assign data to table
	layout:"fitColumns", //fit columns to width of table (optional)
	columns:[ //Define Table Columns
		{title:"Class", field:"name"},
		{title:"Grade", field:"grade", align:"left", formatter:function(cell, formatterParams){
			let numberGrade = parseFloat(cell.getValue());

			if (isNaN(numberGrade)) {
				return "No Grade";

			} else {


				let value = parseFloat(cell.getValue()) + " " + getLetterGrade(cell.getValue());
				if(parseFloat(numberGrade) > 90){
					return "<span style='color:green; font-weight:bold;'>" + value + "</span>";
				} if(parseFloat(numberGrade) > 80){
					return "<span style='color:blue; font-weight:bold;'>" + value + "</span>";
				} if(parseFloat(numberGrade) > 70){
					return "<span style='color:yellow; font-weight:bold;'>" + value + "</span>";
				} if(parseFloat(numberGrade) > 60){
					return "<span style='color:orange; font-weight:bold;'>" + value + "</span>";
				} else{
					return value;
				}}}},
		{title:"Calculated Grade", field:"calculated_grade"},
	],
	rowClick:function(e, row){ //trigger an alert message when the row is clicked
        selected_class_i = row.getPosition();
        tabledata = table.getData();
		for(let i in tabledata) {
			if(tabledata[i].name == row.getData().name) {
				table2.setData(tabledata[i].assignments);
				return;
			}
		}
	},
});
function schedule_toggle() {
    if(document.getElementById("schedule_toggle").checked) {
        table3.setData(tableData.schedule.silver);
    } else {
        table3.setData(tableData.schedule.black);
    }
}
		</script>
		<script type="text/javascript" src="extraFunctions.js"></script>
		<script type="text/javascript" src="calculate_grade.js"></script>

	</body>
</html>
